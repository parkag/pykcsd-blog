<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Refactoring, speeding up (week 8) &#8211; pykCSD @ GSoC</title>
<meta name="description" content="KCSD3D">
<meta name="keywords" content="coding">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Refactoring, speeding up (week 8)">
<meta property="og:description" content="KCSD3D">
<meta property="og:url" content="/pykcsd-blog/articles/week8/">
<meta property="og:site_name" content="pykCSD @ GSoC">





<link rel="canonical" href="/pykcsd-blog/articles/week8/">
<link href="/pykcsd-blog/feed.xml" type="application/atom+xml" rel="alternate" title="pykCSD @ GSoC Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/pykcsd-blog/assets/css/main.min.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/pykcsd-blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/pykcsd-blog/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/pykcsd-blog/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/pykcsd-blog/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/pykcsd-blog/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/pykcsd-blog/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/pykcsd-blog/images/apple-touch-icon-144x144-precomposed.png">


<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
	        
			<li>
				
					<a href="/pykcsd-blog/about/">About</a>
				 
			</li>
	        
			<li>
				
					<a href="/pykcsd-blog/articles/">Articles</a>
				 
			</li>
	        
	        <li><a href="/pykcsd-blog/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
	        <li class="dosearch"><i class="icon-search"></i> Search</li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
	<div class="search-form">
		<input type="text" class="search-field" placeholder="Search...">
		<i class="icon-remove-sign icon-2x"></i>
		<ul class="search-results post-list"></ul><!-- /.search-results -->
	</div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	<div class="wrap">
        
    		<a href="/pykcsd-blog/" class="site-logo" rel="home" title="pykCSD @ GSoC"><img src="/pykcsd-blog/images/site-logo.png" width="200" height="200" alt="pykCSD @ GSoC logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="/pykcsd-blog/">pykCSD @ GSoC</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">A journey through Python implementation of Kernel Current Source Density Method</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="/pykcsd-blog/tags/#coding" title="Pages tagged coding">coding</a></span>
        
          <h1 class="entry-title">Refactoring, speeding up (week 8)</h1>
        
      </header>
      <footer class="entry-meta">
        <img src="/pykcsd-blog/images/profi_photo.jpg" alt="Grzegorz Parka photo" class="author-photo">
        <span class="author vcard">By <span class="fn"><a href="/pykcsd-blog/about/" title="About Grzegorz Parka">Grzegorz Parka</a></span></span>
        <span class="entry-date date published"><time datetime="2014-07-10T00:00:00+02:00"><i class="icon-calendar-empty"></i> July 10, 2014</time></span>
        <span class="entry-date date modified"><time datetime="2014-07-10"><i class="icon-pencil"></i> July 10, 2014</time></span>
        <span class="entry-comments"><i class="icon-comment-alt"></i> <a href="#disqus_thread">Comment</a></span>
        <span><a href="/pykcsd-blog/articles/week8/" rel="bookmark" title="Refactoring, speeding up (week 8)"><i class="icon-link"></i> Permalink</a></span>
        
        <span class="social-share-facebook">
            <a href="https://www.facebook.com/sharer/sharer.php?u=/pykcsd-blog/articles/week8/" title="Share on Facebook" itemprop="Facebook"><i class="icon-facebook-sign"></i> Like</a></span>
        <span class="social-share-twitter">
            <a href="https://twitter.com/intent/tweet?hashtags=articles&text=Refactoring, speeding up (week 8)&url=/pykcsd-blog/articles/week8/&via=" title="Share on Twitter" itemprop="Twitter"><i class="icon-twitter-sign"></i> Tweet</a></span>
        <span class="social-share-googleplus">
            <a href="https://plus.google.com/share?url=/pykcsd-blog/articles/week8/" title="Share on Google Plus" itemprop="GooglePlus"><i class="icon-google-plus-sign"></i> +1</a></span>
            <!-- /.social-share -->
      </footer>
      <div class="entry-content">
        <h3 id="refactoring">Refactoring</h3>

<p>To shorten and modularize the KCSD classes better, I’m moving static functions from KCSD classes to external modules:</p>

<ul>
  <li>cross_validation.py</li>
  <li>basis_functions.py</li>
  <li>source_distributions.py</li>
  <li>potentials.py</li>
  <li>dist_table_utils.py</li>
  <li>plotting_utils.py</li>
</ul>

<p>The names are self-explanatory.</p>

<p>The package is more granular now. It makes it much easier to stick to PEP8 rules.</p>

<p>It’s still not fully PEP8, but over ten times closer to that! (flaw count decreased from 500 to 40 by now)</p>

<p>There is some similar code in the KCSD classes so, it could be beneficial to merge them together, however I didn’t find a good way of doing so yet. </p>

<h3 id="speeding-up">Speeding up</h3>

<h4 id="matrices">Matrices</h4>
<p>The matrix operations already look optimized. Nothing special to improve. Contrary to what I supposed in my proposal, there are no sparse matrices in kCSD in general. Some may only appear in the 1D version, which I investigated at that time. </p>

<p>I’m leaving it as it is now. Messing with it will not bring a significant boost.</p>

<h4 id="integrals">Integrals</h4>
<p>There were serious problems with evaluating double and triple quads, especially when the integrands contained step function.</p>

<p>This is because higher dimensional scipy integrals (nquad, tplquad) don’t handle discontinuities and constant functions well.
Triple quads and nquads completely refused to compute potentials with 3D step basis functions.</p>

<p>To overcome this I decided to use other type of integration method - Monte Carlo method.</p>

<p>I came up with Monte Carlo mthod because it handles both gaussian and step function well. Also the calculation time vs precision tradeoff can be manipulated explicitly by specifing the number of sampling points. </p>

<p>Small comparison between Scipy tplquad and Monte Carlo integral:</p>

<pre><code>In [1]: from pykCSD import potentials as pt
In [2]: from pykCSD import basis_functions as bf
In [3]: from pylab import *
In [4]: x = np.array([0.2 * i for i in xrange(20)])
In [5]: R = 1.0
In [6]: h = 0.5
In [7]: pots_tplquad = np.array([pt.b_pot_3d_cont(xp, R, h, 1.0, bf.gauss_rescale_3D) for xp in x])
In [8]: pots_monte = np.array([pt.b_pot_3d_mc(xp, R, h, 1.0, bf.gauss_rescale_3D) for xp in x])
In [9]: plot(x, pots_tplquad)
In [10]: plot(x, pots_monte)
In [11]: show()
</code></pre>

<figure>
	<a href="/pykcsd-blog/images/figure_monte_tpl.png"><img src="/pykcsd-blog/images/figure_monte_tpl.png" /></a>
<figcaption>Potentials calculated with scipy.integrate.tplquad and Monte Carlo method (scikit-monaco)</figcaption>
</figure>

<figure>
	<a href="/pykcsd-blog/images/figure_mc_tpl_err_pots.png"><img src="/pykcsd-blog/images/figure_mc_tpl_err_pots.png" /></a>
<figcaption>Difference between tplquad and Monte Carlo method (npts=1e5) calculated potentials</figcaption>
</figure>

<figure>
	<a href="/pykcsd-blog/images/figure_mc_tpl_rel_err.png"><img src="/pykcsd-blog/images/figure_mc_tpl_rel_err.png" /></a>
<figcaption>Relative error between tplquad and Monte Carlo method (npts=1e5) calculated potentials</figcaption>
</figure>

<p>Relative error of Monte Carlo integration method is proportional to inverse square root of the number of samples N, err = <script type="math/tex">O
\left(\frac{1}{\sqrt{N}}\right)</script> and is not dependent on the dimensionality of the integrand.</p>

<p>Using 100000 pts gives average relative error below 1%, which should be low enough for most of reconstructions.</p>

<p>Speed comparison for gausian base and 20 calculations:</p>

<pre><code>%time pots_tplquad = np.array([pt.b_pot_3d_cont(xp, R, h, 1.0, bf.gauss_rescale_3D) for xp in x])
CPU times: user 46.8 s, sys: 0 ns, total: 46.8 s
Wall time: 46.9 s
</code></pre>

<p>This takes 46.9 s for SciPy tplquad to complete, now compare to Monte Carlo with 1e5 points:</p>

<pre><code>%time pots_monte = np.array([pt.b_pot_3d_mc(xp, R, h, 1.0, bf.gauss_rescale_3D) for xp in x])
CPU times: user 32 ms, sys: 172 ms, total: 204 ms
Wall time: 19.8 s
</code></pre>

<figure>
	<img src="/pykcsd-blog/images/gsoc_horizontal.jpg" width="100%" />
</figure>

        <div id="disqus_thread"></div><!-- /#disqus_thread -->
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/pykcsd-blog/articles/week7/" class="btn" title="Three dimensional kCSD (week 7)">Previous article</a>
      
      
        <a href="/pykcsd-blog/articles/week9/" class="btn" title="Refactoring continued (week 9)">Next article</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Grzegorz Parka. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	
	<a href="http://facebook.com/grzegorz.parka" title="Grzegorz Parka on Facebook" target="_blank"><i class="icon-facebook icon-2x"></i></a>
	
	<a href="http://linkedin.com/in/parkag" title="Grzegorz Parka on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	
	
	
	<a href="http://github.com/parkag" title="Grzegorz Parka on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/pykcsd-blog/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/pykcsd-blog/assets/js/scripts.min.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : '/pykcsd-blog/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'parkaggithubiopykcsdblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>	        

</body>
</html>
